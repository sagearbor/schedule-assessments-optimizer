graph TB
    subgraph "User Interface Layer"
        A[User] -->|Upload Excel/CSV| B[Frontend React App]
        B -->|Parse File| C[File Parser]
        C -->|Extract Schedule Data| D[Schedule Validator]
    end
    
    subgraph "API Gateway"
        D -->|POST Request| E[FastAPI Backend]
        E -->|JWT Auth| F[Authentication Service]
        F -->|Validate Token| G[User Session]
    end
    
    subgraph "Core Processing Engine"
        E -->|Schedule Object| H[Rules Engine]
        
        H -->|Rule 1| I[Redundancy Detection]
        I -->|Find Duplicates| J[Assessment Comparator]
        
        H -->|Rule 2| K[Visit Consolidation]
        K -->|Analyze Proximity| L[Timeline Analyzer]
        
        H -->|Rule 3| M[Feasibility Check]
        M -->|Query Knowledge| N[MCP Services]
    end
    
    subgraph "MCP Integration Layer"
        N -->|HTTP Request| O[Protocol Complexity Analyzer]
        N -->|HTTP Request| P[Compliance Knowledge Base]
        O -->|Complexity Score| M
        P -->|Compliance Data| M
    end
    
    subgraph "Burden Calculation"
        H -->|Assessment Data| Q[Burden Calculator]
        Q -->|Patient Metrics| R[Patient Burden Score]
        Q -->|Site Metrics| S[Site Burden Score]
        R -->|Time, Travel, Invasiveness| T[Weighted Score]
        S -->|Staff, Equipment, Cost| U[Resource Score]
    end
    
    subgraph "Data Persistence"
        E -->|Store Schedule| V[SQLite Database]
        V -->|User Data| W[User Table]
        V -->|Optimization History| X[History Table]
        V -->|Schedule Data| Y[Schedule Table]
    end
    
    subgraph "Results Processing"
        T -->|Aggregate| Z[Optimization Result]
        U -->|Aggregate| Z
        J -->|Recommendations| Z
        L -->|Suggestions| Z
        M -->|Warnings| Z
        Z -->|JSON Response| E
        E -->|Return to Frontend| B
        B -->|Render Visualization| AA[Results Dashboard]
        AA -->|Display to User| A
    end
    
    style A fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    style E fill:#f3e5f5,stroke:#4a148c,stroke-width:3px
    style H fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px
    style Q fill:#fce4ec,stroke:#880e4f,stroke-width:3px
    style Z fill:#fff9c4,stroke:#f57f17,stroke-width:3px